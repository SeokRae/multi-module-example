name: Claude Code Auto Development Workflow

on:
  workflow_dispatch:
    inputs:
      feature_name:
        description: 'Feature name (e.g., cache-redis, batch-processing)'
        required: true
        type: string
      description:
        description: 'Detailed feature description'
        required: true
        type: string
      phase_name:
        description: 'Phase name (e.g., Phase Cache, Phase Batch)'
        required: false
        type: string
        default: 'Feature Development'
      
  # Trigger on specific issue comments
  issue_comment:
    types: [created]

jobs:
  # Job 1: Create Issue and Branch (if triggered manually)
  setup-development:
    if: github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write
    outputs:
      issue_number: ${{ steps.create_issue.outputs.issue_number }}
      branch_name: ${{ steps.create_branch.outputs.branch_name }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Create GitHub Issue
        id: create_issue
        uses: actions/github-script@v7
        with:
          script: |
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `${{ github.event.inputs.phase_name }}: ${{ github.event.inputs.feature_name }}`,
              body: `## ğŸ¯ ìë™ ìƒì„±ëœ ê°œë°œ ì´ìŠˆ
            
            **ê¸°ëŠ¥ ì´ë¦„**: ${{ github.event.inputs.feature_name }}
            **Phase**: ${{ github.event.inputs.phase_name }}
            
            ## ğŸ“‹ êµ¬í˜„ ë‚´ìš©
            ${{ github.event.inputs.description }}
            
            ## âœ… ì²´í¬ë¦¬ìŠ¤íŠ¸
            - [ ] ì½”ë“œ êµ¬í˜„
            - [ ] í…ŒìŠ¤íŠ¸ ì‘ì„±  
            - [ ] ë¬¸ì„œí™”
            - [ ] CI/CD í†µê³¼
            - [ ] ì½”ë“œ ë¦¬ë·°
            - [ ] PR ë¨¸ì§€
            
            ## ğŸ¤– Claude Code Auto Workflow
            ì´ ì´ìŠˆëŠ” Claude Code ìë™ ê°œë°œ ì›Œí¬í”Œë¡œìš°ì— ì˜í•´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.
            
            ğŸš€ Generated with [Claude Code](https://claude.ai/code)
            `,
              labels: ['enhancement', 'claude-auto', 'in-progress']
            });
            
            core.setOutput('issue_number', issue.data.number);
            return issue.data.number;

      - name: Create Feature Branch
        id: create_branch
        run: |
          BRANCH_NAME="feature/${{ github.event.inputs.feature_name }}"
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
          
          git config user.name "claude-code[bot]"
          git config user.email "claude-code@anthropic.com"
          
          git checkout -b "$BRANCH_NAME"
          git push -u origin "$BRANCH_NAME"
          
          echo "âœ… Created branch: $BRANCH_NAME"

      - name: Comment on Issue
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ steps.create_issue.outputs.issue_number }},
              body: `ğŸŒ¿ **í”¼ì²˜ ë¸Œëœì¹˜ ìƒì„± ì™„ë£Œ**
              
              ë¸Œëœì¹˜: \`${{ steps.create_branch.outputs.branch_name }}\`
              
              Claude Codeê°€ ê°œë°œì„ ì‹œì‘í•  ì¤€ë¹„ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! ğŸš€`
            });

  # Job 2: Claude Code Development Trigger
  claude-development:
    needs: setup-development
    if: github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
    
    steps:
      - name: Trigger Claude Code Development
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ needs.setup-development.outputs.issue_number }},
              body: `@claude-code ê°œë°œì„ ì‹œì‘í•´ì£¼ì„¸ìš”!
              
              **ìš”ì²­ ì‚¬í•­**: ${{ github.event.inputs.description }}
              **ë¸Œëœì¹˜**: ${{ needs.setup-development.outputs.branch_name }}
              
              ìë™ ê°œë°œ ì›Œí¬í”Œë¡œìš°ë¥¼ ì‹¤í–‰í•´ì£¼ì„¸ìš”. ğŸ¤–`
            });

  # Job 3: Auto-merge when ready (triggered by PR)
  auto-merge-check:
    if: github.event_name == 'pull_request' && contains(github.event.pull_request.labels.*.name, 'claude-auto')
    runs-on: ubuntu-latest
    
    steps:
      - name: Check CI Status
        uses: actions/github-script@v7
        with:
          script: |
            const { data: checks } = await github.rest.checks.listForRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: context.payload.pull_request.head.sha
            });
            
            const failedChecks = checks.check_runs.filter(check => 
              check.status === 'completed' && check.conclusion === 'failure'
            );
            
            if (failedChecks.length > 0) {
              core.setFailed(`âŒ CI checks failed: ${failedChecks.map(c => c.name).join(', ')}`);
            } else {
              console.log('âœ… All CI checks passed');
            }

      - name: Auto-approve PR
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.pulls.createReview({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.pull_request.number,
              event: 'APPROVE',
              body: 'ğŸ¤– **Claude Code ìë™ ìŠ¹ì¸**\n\nëª¨ë“  CI ê²€ì‚¬ê°€ í†µê³¼í–ˆìŠµë‹ˆë‹¤. ìë™ìœ¼ë¡œ ìŠ¹ì¸í•©ë‹ˆë‹¤!'
            });

      - name: Auto-merge PR
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.pulls.merge({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.pull_request.number,
              merge_method: 'squash',
              commit_title: `ğŸ¤– Auto-merge: ${context.payload.pull_request.title}`,
              commit_message: `Automatically merged by Claude Code workflow\n\n${context.payload.pull_request.body}`
            });

  # Job 4: Cleanup and Notification
  workflow-complete:
    needs: [setup-development, claude-development]
    if: always() && github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    
    steps:
      - name: Workflow Summary
        uses: actions/github-script@v7
        with:
          script: |
            const summary = `## ğŸ¤– Claude Code ìë™ ê°œë°œ ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ë¨
            
            **ê¸°ëŠ¥**: ${{ github.event.inputs.feature_name }}
            **Phase**: ${{ github.event.inputs.phase_name }}
            **ì´ìŠˆ**: #${{ needs.setup-development.outputs.issue_number }}
            **ë¸Œëœì¹˜**: ${{ needs.setup-development.outputs.branch_name }}
            
            ### ë‹¤ìŒ ë‹¨ê³„
            1. âœ… GitHub ì´ìŠˆ ìƒì„±
            2. âœ… í”¼ì²˜ ë¸Œëœì¹˜ ìƒì„±
            3. ğŸ”„ Claude Code ê°œë°œ ëŒ€ê¸° ì¤‘...
            
            Claude Codeê°€ ìë™ìœ¼ë¡œ ê°œë°œì„ ì§„í–‰í•  ì˜ˆì •ì…ë‹ˆë‹¤.`;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ needs.setup-development.outputs.issue_number }},
              body: summary
            });