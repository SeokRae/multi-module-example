name: Pull Request Checks

on:
  pull_request:
    branches: [ main, develop ]
    types: [opened, synchronize, reopened, ready_for_review]

env:
  JAVA_VERSION: '17'
  GRADLE_OPTS: '-Dorg.gradle.daemon=false'

jobs:
  # PR 제목 및 브랜치명 검증
  pr-validation:
    name: Validate PR
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    permissions:
      contents: read
      pull-requests: write
      checks: write
    steps:
      - name: Validate PR title
        uses: amannn/action-semantic-pull-request@v5
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          types: |
            feat
            fix
            docs
            style
            refactor
            perf
            test
            chore
            ci
            build
          scopes: |
            user
            product
            order
            auth
            api
            db
            security
            cache
            batch
            ci
          requireScope: false
          disallowScopes: |
            release
          subjectPattern: ^(?![A-Z]).+$
          subjectPatternError: |
            The subject "{subject}" found in the pull request title "{title}"
            didn't match the configured pattern. Please ensure that the subject
            doesn't start with an uppercase character.

      - name: Validate branch name
        run: |
          branch_name="${{ github.head_ref }}"
          if [[ ! "$branch_name" =~ ^(feature|fix|hotfix|docs|chore)\/[a-z0-9-]+$ ]]; then
            echo "❌ Branch name '$branch_name' does not follow the naming convention."
            echo "Expected format: type/description (e.g., feature/user-authentication)"
            echo "Valid types: feature, fix, hotfix, docs, chore"
            exit 1
          else
            echo "✅ Branch name '$branch_name' follows the naming convention."
          fi

  # 빠른 검증 (PR용)
  quick-check:
    name: Quick Validation
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # 전체 히스토리 가져오기 (diff를 위해 필요)

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'

      - name: Setup Gradle with enhanced caching
        uses: gradle/gradle-build-action@v3
        with:
          cache-read-only: false
          cache-write-only: false
          gradle-home-cache-cleanup: true

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Run quick compilation check (optimized)
        run: ./gradlew compileJava compileTestJava --parallel --build-cache

      - name: Run affected module tests
        run: |
          # 변경된 파일을 기반으로 영향받는 모듈 감지 (GitHub 컨텍스트 사용)
          changed_files=$(git diff --name-only ${{ github.event.pull_request.base.sha }}...${{ github.sha }})
          echo "Changed files: $changed_files"
          
          # 테스트가 있는 모듈만 실행하는 함수
          run_tests_if_exist() {
            local module=$1
            local module_path=$(echo "$module" | sed 's/:/\//g')
            
            if [ -d "$module_path/src/test" ] && [ "$(find $module_path/src/test -name '*.java' | wc -l)" -gt 0 ]; then
              echo "⚡ Running optimized tests for $module..."
              ./gradlew :$module:test --parallel --build-cache
            else
              echo "⏭️ No tests found for $module, skipping..."
            fi
          }
          
          # 간단한 모듈 감지 로직
          if echo "$changed_files" | grep -q "common/"; then
            echo "Testing common modules..."
            run_tests_if_exist "common:common-core"
            run_tests_if_exist "common:common-web"
            run_tests_if_exist "common:common-security"
            run_tests_if_exist "common:common-cache"
          fi
          
          if echo "$changed_files" | grep -q "domain/user"; then
            echo "Testing user domain..."
            run_tests_if_exist "domain:user-domain"
          fi
          
          if echo "$changed_files" | grep -q "application/user-api"; then
            echo "Testing user-api..."
            run_tests_if_exist "application:user-api"
          fi
          
          # 전체 테스트가 빠르게 실행되는 경우 - 테스트 파일이 있는 모듈만 실행
          if [ $(echo "$changed_files" | wc -l) -lt 5 ]; then
            echo "🚀 Running optimized test suite for small changes..."
            # 모든 모듈을 확인하고 테스트가 있는 것만 병렬로 실행
            for module in common:common-core common:common-web common:common-security common:common-cache domain:user-domain domain:product-domain domain:order-domain infrastructure:data-access infrastructure:cache-infrastructure application:user-api application:batch-app; do
              run_tests_if_exist "$module"
            done
          fi

  # 문서 변경 검증
  docs-check:
    name: Documentation Check
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # 전체 히스토리 가져오기 (diff를 위해 필요)

      - name: Check for README updates
        run: |
          changed_files=$(git diff --name-only ${{ github.event.pull_request.base.sha }}...${{ github.sha }})
          
          # API 변경시 문서 업데이트 확인
          if echo "$changed_files" | grep -q "Controller.java\|@RestController"; then
            if ! echo "$changed_files" | grep -q "docs/\|README"; then
              echo "⚠️ API 변경이 감지되었지만 문서가 업데이트되지 않았습니다."
              echo "docs/ 폴더나 README 파일 업데이트를 고려해주세요."
            fi
          fi

      - name: Check for breaking changes
        run: |
          changed_files=$(git diff --name-only ${{ github.event.pull_request.base.sha }}...${{ github.sha }})
          
          # 잠재적 Breaking Change 감지
          if echo "$changed_files" | grep -q "build.gradle\|application.yml\|Entity.java"; then
            echo "🔍 잠재적 Breaking Change가 감지되었습니다:"
            echo "$changed_files" | grep -E "(build.gradle|application.yml|Entity.java)"
            echo "변경사항이 하위 호환성에 영향을 주는지 확인해주세요."
          fi

  # 보안 체크
  security-check:
    name: Security Check
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # 전체 히스토리 가져오기 (diff를 위해 필요)

      - name: Check for secrets
        run: |
          # 민감한 정보 패턴 검색 (워크플로우 및 문서 파일 제외)
          if git diff ${{ github.event.pull_request.base.sha }}...${{ github.sha }} -- ':!.github/workflows/*' ':!docs/*' ':!*.md' | grep -iE "(password|secret|key|token)" | grep -E "\+.*=" | grep -v '\${{ secrets\.' | grep -v 'property.*token'; then
            echo "❌ 잠재적으로 민감한 정보가 감지되었습니다:"
            git diff ${{ github.event.pull_request.base.sha }}...${{ github.sha }} -- ':!.github/workflows/*' ':!docs/*' ':!*.md' | grep -iE "(password|secret|key|token)" | grep -E "\+.*=" | grep -v '\${{ secrets\.' | grep -v 'property.*token'
            echo "하드코딩된 비밀정보가 없는지 확인해주세요."
            exit 1
          else
            echo "✅ 민감한 정보 패턴이 감지되지 않았습니다."
          fi

      - name: Check for SQL injection patterns
        run: |
          # 잠재적 SQL 인젝션 패턴 검색
          if git diff ${{ github.event.pull_request.base.sha }}...${{ github.sha }} | grep -E "\+.*\.(createQuery|createNativeQuery|execute)" | grep -v "?" ; then
            echo "⚠️ SQL 쿼리에서 파라미터 바인딩을 사용하지 않는 패턴이 감지되었습니다."
            echo "SQL 인젝션 방지를 위해 PreparedStatement나 JPA 파라미터를 사용해주세요."
          fi

  # 성능 체크 (간단한 메트릭)
  performance-check:
    name: Performance Check
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # 전체 히스토리 가져오기 (diff를 위해 필요)

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'

      - name: Setup Gradle with enhanced caching
        uses: gradle/gradle-build-action@v3
        with:
          cache-read-only: false
          cache-write-only: false
          gradle-home-cache-cleanup: true

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Check build performance (optimized)
        run: |
          echo "🚀 최적화된 빌드 성능 측정 중..."
          start_time=$(date +%s)
          ./gradlew build -x test --quiet --parallel --build-cache
          end_time=$(date +%s)
          duration=$((end_time - start_time))
          
          echo "⏱️ 빌드 시간: ${duration}초"
          
          if [ $duration -gt 300 ]; then
            echo "⚠️ 빌드 시간이 5분을 초과했습니다. 빌드 최적화를 고려해주세요."
          elif [ $duration -gt 120 ]; then
            echo "⚠️ 빌드 시간이 2분을 초과했습니다."
          else
            echo "✅ 빌드 성능이 양호합니다."
          fi