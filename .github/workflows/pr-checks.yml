name: Pull Request Checks

on:
  pull_request:
    branches: [ main, develop ]
    types: [opened, synchronize, reopened, ready_for_review]

env:
  JAVA_VERSION: '17'
  GRADLE_OPTS: '-Dorg.gradle.daemon=false'

jobs:
  # PR ì œëª© ë° ë¸Œëœì¹˜ëª… ê²€ì¦
  pr-validation:
    name: Validate PR
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    permissions:
      contents: read
      pull-requests: write
      checks: write
    steps:
      - name: Validate PR title
        uses: amannn/action-semantic-pull-request@v5
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          types: |
            feat
            fix
            docs
            style
            refactor
            perf
            test
            chore
            ci
            build
          scopes: |
            user
            product
            order
            auth
            api
            db
            security
            cache
            batch
            ci
          requireScope: false
          disallowScopes: |
            release
          subjectPattern: ^(?![A-Z]).+$
          subjectPatternError: |
            The subject "{subject}" found in the pull request title "{title}"
            didn't match the configured pattern. Please ensure that the subject
            doesn't start with an uppercase character.

      - name: Validate branch name
        run: |
          branch_name="${{ github.head_ref }}"
          if [[ ! "$branch_name" =~ ^(feature|fix|hotfix|docs|chore)\/[a-z0-9-]+$ ]]; then
            echo "âŒ Branch name '$branch_name' does not follow the naming convention."
            echo "Expected format: type/description (e.g., feature/user-authentication)"
            echo "Valid types: feature, fix, hotfix, docs, chore"
            exit 1
          else
            echo "âœ… Branch name '$branch_name' follows the naming convention."
          fi

  # ë¹ ë¥¸ ê²€ì¦ (PRìš©)
  quick-check:
    name: Quick Validation
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # ì „ì²´ íˆìŠ¤í† ë¦¬ ê°€ì ¸ì˜¤ê¸° (diffë¥¼ ìœ„í•´ í•„ìš”)

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'

      - name: Setup Gradle with enhanced caching
        uses: gradle/gradle-build-action@v3
        with:
          cache-read-only: false
          cache-write-only: false
          gradle-home-cache-cleanup: true

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Run quick compilation check (optimized)
        run: ./gradlew compileJava compileTestJava --parallel --build-cache

      - name: Run affected module tests
        run: |
          # ë³€ê²½ëœ íŒŒì¼ì„ ê¸°ë°˜ìœ¼ë¡œ ì˜í–¥ë°›ëŠ” ëª¨ë“ˆ ê°ì§€ (GitHub ì»¨í…ìŠ¤íŠ¸ ì‚¬ìš©)
          changed_files=$(git diff --name-only ${{ github.event.pull_request.base.sha }}...${{ github.sha }})
          echo "Changed files: $changed_files"
          
          # í…ŒìŠ¤íŠ¸ê°€ ìˆëŠ” ëª¨ë“ˆë§Œ ì‹¤í–‰í•˜ëŠ” í•¨ìˆ˜
          run_tests_if_exist() {
            local module=$1
            local module_path=$(echo "$module" | sed 's/:/\//g')
            
            if [ -d "$module_path/src/test" ] && [ "$(find $module_path/src/test -name '*.java' | wc -l)" -gt 0 ]; then
              echo "âš¡ Running optimized tests for $module..."
              ./gradlew :$module:test --parallel --build-cache
            else
              echo "â­ï¸ No tests found for $module, skipping..."
            fi
          }
          
          # ê°„ë‹¨í•œ ëª¨ë“ˆ ê°ì§€ ë¡œì§
          if echo "$changed_files" | grep -q "common/"; then
            echo "Testing common modules..."
            run_tests_if_exist "common:common-core"
            run_tests_if_exist "common:common-web"
            run_tests_if_exist "common:common-security"
            run_tests_if_exist "common:common-cache"
          fi
          
          if echo "$changed_files" | grep -q "domain/user"; then
            echo "Testing user domain..."
            run_tests_if_exist "domain:user-domain"
          fi
          
          if echo "$changed_files" | grep -q "application/user-api"; then
            echo "Testing user-api..."
            run_tests_if_exist "application:user-api"
          fi
          
          # ì „ì²´ í…ŒìŠ¤íŠ¸ê°€ ë¹ ë¥´ê²Œ ì‹¤í–‰ë˜ëŠ” ê²½ìš° - í…ŒìŠ¤íŠ¸ íŒŒì¼ì´ ìˆëŠ” ëª¨ë“ˆë§Œ ì‹¤í–‰
          if [ $(echo "$changed_files" | wc -l) -lt 5 ]; then
            echo "ğŸš€ Running optimized test suite for small changes..."
            # ëª¨ë“  ëª¨ë“ˆì„ í™•ì¸í•˜ê³  í…ŒìŠ¤íŠ¸ê°€ ìˆëŠ” ê²ƒë§Œ ë³‘ë ¬ë¡œ ì‹¤í–‰
            for module in common:common-core common:common-web common:common-security common:common-cache domain:user-domain domain:product-domain domain:order-domain infrastructure:data-access infrastructure:cache-infrastructure application:user-api application:batch-app; do
              run_tests_if_exist "$module"
            done
          fi

  # ë¬¸ì„œ ë³€ê²½ ê²€ì¦
  docs-check:
    name: Documentation Check
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # ì „ì²´ íˆìŠ¤í† ë¦¬ ê°€ì ¸ì˜¤ê¸° (diffë¥¼ ìœ„í•´ í•„ìš”)

      - name: Check for README updates
        run: |
          changed_files=$(git diff --name-only ${{ github.event.pull_request.base.sha }}...${{ github.sha }})
          
          # API ë³€ê²½ì‹œ ë¬¸ì„œ ì—…ë°ì´íŠ¸ í™•ì¸
          if echo "$changed_files" | grep -q "Controller.java\|@RestController"; then
            if ! echo "$changed_files" | grep -q "docs/\|README"; then
              echo "âš ï¸ API ë³€ê²½ì´ ê°ì§€ë˜ì—ˆì§€ë§Œ ë¬¸ì„œê°€ ì—…ë°ì´íŠ¸ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
              echo "docs/ í´ë”ë‚˜ README íŒŒì¼ ì—…ë°ì´íŠ¸ë¥¼ ê³ ë ¤í•´ì£¼ì„¸ìš”."
            fi
          fi

      - name: Check for breaking changes
        run: |
          changed_files=$(git diff --name-only ${{ github.event.pull_request.base.sha }}...${{ github.sha }})
          
          # ì ì¬ì  Breaking Change ê°ì§€
          if echo "$changed_files" | grep -q "build.gradle\|application.yml\|Entity.java"; then
            echo "ğŸ” ì ì¬ì  Breaking Changeê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤:"
            echo "$changed_files" | grep -E "(build.gradle|application.yml|Entity.java)"
            echo "ë³€ê²½ì‚¬í•­ì´ í•˜ìœ„ í˜¸í™˜ì„±ì— ì˜í–¥ì„ ì£¼ëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”."
          fi

  # ë³´ì•ˆ ì²´í¬
  security-check:
    name: Security Check
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # ì „ì²´ íˆìŠ¤í† ë¦¬ ê°€ì ¸ì˜¤ê¸° (diffë¥¼ ìœ„í•´ í•„ìš”)

      - name: Check for secrets
        run: |
          # ë¯¼ê°í•œ ì •ë³´ íŒ¨í„´ ê²€ìƒ‰ (ì›Œí¬í”Œë¡œìš° ë° ë¬¸ì„œ íŒŒì¼ ì œì™¸)
          if git diff ${{ github.event.pull_request.base.sha }}...${{ github.sha }} -- ':!.github/workflows/*' ':!docs/*' ':!*.md' | grep -iE "(password|secret|key|token)" | grep -E "\+.*=" | grep -v '\${{ secrets\.' | grep -v 'property.*token'; then
            echo "âŒ ì ì¬ì ìœ¼ë¡œ ë¯¼ê°í•œ ì •ë³´ê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤:"
            git diff ${{ github.event.pull_request.base.sha }}...${{ github.sha }} -- ':!.github/workflows/*' ':!docs/*' ':!*.md' | grep -iE "(password|secret|key|token)" | grep -E "\+.*=" | grep -v '\${{ secrets\.' | grep -v 'property.*token'
            echo "í•˜ë“œì½”ë”©ëœ ë¹„ë°€ì •ë³´ê°€ ì—†ëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”."
            exit 1
          else
            echo "âœ… ë¯¼ê°í•œ ì •ë³´ íŒ¨í„´ì´ ê°ì§€ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
          fi

      - name: Check for SQL injection patterns
        run: |
          # ì ì¬ì  SQL ì¸ì ì…˜ íŒ¨í„´ ê²€ìƒ‰
          if git diff ${{ github.event.pull_request.base.sha }}...${{ github.sha }} | grep -E "\+.*\.(createQuery|createNativeQuery|execute)" | grep -v "?" ; then
            echo "âš ï¸ SQL ì¿¼ë¦¬ì—ì„œ íŒŒë¼ë¯¸í„° ë°”ì¸ë”©ì„ ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” íŒ¨í„´ì´ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤."
            echo "SQL ì¸ì ì…˜ ë°©ì§€ë¥¼ ìœ„í•´ PreparedStatementë‚˜ JPA íŒŒë¼ë¯¸í„°ë¥¼ ì‚¬ìš©í•´ì£¼ì„¸ìš”."
          fi

  # ì„±ëŠ¥ ì²´í¬ (ê°„ë‹¨í•œ ë©”íŠ¸ë¦­)
  performance-check:
    name: Performance Check
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # ì „ì²´ íˆìŠ¤í† ë¦¬ ê°€ì ¸ì˜¤ê¸° (diffë¥¼ ìœ„í•´ í•„ìš”)

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'

      - name: Setup Gradle with enhanced caching
        uses: gradle/gradle-build-action@v3
        with:
          cache-read-only: false
          cache-write-only: false
          gradle-home-cache-cleanup: true

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Check build performance (optimized)
        run: |
          echo "ğŸš€ ìµœì í™”ëœ ë¹Œë“œ ì„±ëŠ¥ ì¸¡ì • ì¤‘..."
          start_time=$(date +%s)
          ./gradlew build -x test --quiet --parallel --build-cache
          end_time=$(date +%s)
          duration=$((end_time - start_time))
          
          echo "â±ï¸ ë¹Œë“œ ì‹œê°„: ${duration}ì´ˆ"
          
          if [ $duration -gt 300 ]; then
            echo "âš ï¸ ë¹Œë“œ ì‹œê°„ì´ 5ë¶„ì„ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤. ë¹Œë“œ ìµœì í™”ë¥¼ ê³ ë ¤í•´ì£¼ì„¸ìš”."
          elif [ $duration -gt 120 ]; then
            echo "âš ï¸ ë¹Œë“œ ì‹œê°„ì´ 2ë¶„ì„ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤."
          else
            echo "âœ… ë¹Œë“œ ì„±ëŠ¥ì´ ì–‘í˜¸í•©ë‹ˆë‹¤."
          fi