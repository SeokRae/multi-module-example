#!/bin/bash

# GitHub Flow í—¬í¼ í•¨ìˆ˜ë“¤
# ì‚¬ìš©ë²•: source scripts/github-flow-helpers.sh

# ìƒ‰ìƒ ì½”ë“œ
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤
print_success() {
    echo -e "${GREEN}âœ… $1${NC}"
}

print_warning() {
    echo -e "${YELLOW}âš ï¸  $1${NC}"
}

print_error() {
    echo -e "${RED}âŒ $1${NC}"
}

print_info() {
    echo -e "${BLUE}â„¹ï¸  $1${NC}"
}

# GitHub Flow ì›Œí¬í”Œë¡œìš° í•¨ìˆ˜ë“¤

# ìƒˆë¡œìš´ ê¸°ëŠ¥ ì‹œì‘
gf_start() {
    local feature_name=$1
    
    if [ -z "$feature_name" ]; then
        print_error "ê¸°ëŠ¥ëª…ì„ ì…ë ¥í•˜ì„¸ìš”."
        echo "ì‚¬ìš©ë²•: gf_start <feature-name>"
        echo "ì˜ˆì‹œ: gf_start user-authentication"
        return 1
    fi
    
    print_info "ğŸš€ GitHub Flow ê¸°ëŠ¥ ê°œë°œ ì‹œì‘: $feature_name"
    
    # main ë¸Œëœì¹˜ì—ì„œ ìµœì‹  ìƒíƒœë¡œ ì‹œì‘
    git checkout main || return 1
    git pull origin main || return 1
    git checkout -b "feature/$feature_name" || return 1
    
    print_success "ë¸Œëœì¹˜ 'feature/$feature_name' ìƒì„± ì™„ë£Œ"
    print_info "ğŸ“ ê°œë°œ ì™„ë£Œ í›„ ë‹¤ìŒ ëª…ë ¹ì–´ë¡œ PRì„ ìƒì„±í•˜ì„¸ìš”:"
    echo "   gf_pr 'Add $feature_name' 'Description of changes'"
}

# ë²„ê·¸ ìˆ˜ì • ì‹œì‘
gf_bugfix() {
    local bug_name=$1
    
    if [ -z "$bug_name" ]; then
        print_error "ë²„ê·¸ ìˆ˜ì •ëª…ì„ ì…ë ¥í•˜ì„¸ìš”."
        echo "ì‚¬ìš©ë²•: gf_bugfix <bug-name>"
        echo "ì˜ˆì‹œ: gf_bugfix login-issue"
        return 1
    fi
    
    print_info "ğŸ› ë²„ê·¸ ìˆ˜ì • ì‹œì‘: $bug_name"
    
    git checkout main || return 1
    git pull origin main || return 1
    git checkout -b "bugfix/$bug_name" || return 1
    
    print_success "ë¸Œëœì¹˜ 'bugfix/$bug_name' ìƒì„± ì™„ë£Œ"
}

# ë¬¸ì„œ ì—…ë°ì´íŠ¸ ì‹œì‘
gf_docs() {
    local docs_name=$1
    
    if [ -z "$docs_name" ]; then
        print_error "ë¬¸ì„œ ì—…ë°ì´íŠ¸ëª…ì„ ì…ë ¥í•˜ì„¸ìš”."
        echo "ì‚¬ìš©ë²•: gf_docs <docs-name>"
        echo "ì˜ˆì‹œ: gf_docs update-readme"
        return 1
    fi
    
    print_info "ğŸ“š ë¬¸ì„œ ì—…ë°ì´íŠ¸ ì‹œì‘: $docs_name"
    
    git checkout main || return 1
    git pull origin main || return 1
    git checkout -b "docs/$docs_name" || return 1
    
    print_success "ë¸Œëœì¹˜ 'docs/$docs_name' ìƒì„± ì™„ë£Œ"
}

# Pull Request ìƒì„±
gf_pr() {
    local title=$1
    local body=$2
    
    if [ -z "$title" ]; then
        print_error "PR ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”."
        echo "ì‚¬ìš©ë²•: gf_pr <title> [body]"
        echo "ì˜ˆì‹œ: gf_pr 'Add user authentication' 'Implements login and logout functionality'"
        return 1
    fi
    
    if [ -z "$body" ]; then
        body="Generated by GitHub Flow helper script"
    fi
    
    print_info "ğŸ“ Pull Request ìƒì„± ì¤‘..."
    
    # í˜„ì¬ ë¸Œëœì¹˜ í‘¸ì‹œ
    current_branch=$(git branch --show-current)
    git push -u origin "$current_branch" || return 1
    
    # GitHub CLIë¥¼ ì‚¬ìš©í•˜ì—¬ PR ìƒì„±
    if command -v gh &> /dev/null; then
        gh pr create --title "$title" --body "$body" || return 1
        print_success "Pull Requestê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤."
    else
        print_warning "GitHub CLI(gh)ê°€ ì„¤ì¹˜ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤."
        print_info "ì›¹ ë¸Œë¼ìš°ì €ì—ì„œ GitHubì— ì ‘ì†í•˜ì—¬ ìˆ˜ë™ìœ¼ë¡œ PRì„ ìƒì„±í•˜ì„¸ìš”."
        print_info "ë¸Œëœì¹˜ '$current_branch'ê°€ ì›ê²© ì €ì¥ì†Œì— í‘¸ì‹œë˜ì—ˆìŠµë‹ˆë‹¤."
    fi
}

# ë¸Œëœì¹˜ ìƒíƒœ í™•ì¸
gf_status() {
    print_info "ğŸ“Š GitHub Flow ìƒíƒœ í™•ì¸"
    echo ""
    
    # í˜„ì¬ ë¸Œëœì¹˜
    current_branch=$(git branch --show-current)
    echo "í˜„ì¬ ë¸Œëœì¹˜: $current_branch"
    echo ""
    
    # mainê³¼ì˜ ì°¨ì´
    if [ "$current_branch" != "main" ]; then
        echo "main ë¸Œëœì¹˜ì™€ì˜ ì°¨ì´:"
        ahead=$(git rev-list --count main.."$current_branch" 2>/dev/null || echo "0")
        behind=$(git rev-list --count "$current_branch"..main 2>/dev/null || echo "0")
        echo "  ì•ì„  ì»¤ë°‹: $ahead"
        echo "  ë’¤ì²˜ì§„ ì»¤ë°‹: $behind"
        echo ""
    fi
    
    # ì‘ì—… ìƒíƒœ
    if [[ -n $(git status --porcelain) ]]; then
        print_warning "ë¯¸ì™„ë£Œ ë³€ê²½ì‚¬í•­ì´ ìˆìŠµë‹ˆë‹¤:"
        git status --short
    else
        print_success "ì‘ì—… ë””ë ‰í† ë¦¬ê°€ ê¹¨ë—í•©ë‹ˆë‹¤."
    fi
    echo ""
    
    # feature ë¸Œëœì¹˜ë“¤
    feature_branches=$(git branch --list "feature/*" "bugfix/*" "docs/*" | sed 's/^..//')
    if [[ -n "$feature_branches" ]]; then
        echo "ì§„í–‰ ì¤‘ì¸ ë¸Œëœì¹˜ë“¤:"
        echo "$feature_branches"
    else
        echo "ì§„í–‰ ì¤‘ì¸ ê¸°ëŠ¥ ë¸Œëœì¹˜ê°€ ì—†ìŠµë‹ˆë‹¤."
    fi
}

# main ë¸Œëœì¹˜ì™€ ë™ê¸°í™”
gf_sync() {
    local current_branch=$(git branch --show-current)
    
    print_info "ğŸ”„ main ë¸Œëœì¹˜ì™€ ë™ê¸°í™” ì¤‘..."
    
    # í˜„ì¬ ë¸Œëœì¹˜ì˜ ë³€ê²½ì‚¬í•­ í™•ì¸
    if [[ -n $(git status --porcelain) ]]; then
        print_warning "ë¯¸ì™„ë£Œ ë³€ê²½ì‚¬í•­ì´ ìˆìŠµë‹ˆë‹¤. stash ë˜ëŠ” ì»¤ë°‹ í›„ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”."
        return 1
    fi
    
    # main ë¸Œëœì¹˜ë¡œ ì „í™˜í•˜ê³  ìµœì‹ í™”
    git checkout main || return 1
    git pull origin main || return 1
    
    # ì›ë˜ ë¸Œëœì¹˜ë¡œ ëŒì•„ê°€ì„œ rebase
    if [ "$current_branch" != "main" ]; then
        git checkout "$current_branch" || return 1
        git rebase main || {
            print_error "Rebase ì¤‘ ì¶©ëŒì´ ë°œìƒí–ˆìŠµë‹ˆë‹¤."
            print_info "ì¶©ëŒì„ í•´ê²°í•œ í›„ 'git rebase --continue'ë¥¼ ì‹¤í–‰í•˜ì„¸ìš”."
            return 1
        }
        print_success "ë¸Œëœì¹˜ '$current_branch'ë¥¼ mainê³¼ ë™ê¸°í™”í–ˆìŠµë‹ˆë‹¤."
    else
        print_success "main ë¸Œëœì¹˜ê°€ ìµœì‹  ìƒíƒœì…ë‹ˆë‹¤."
    fi
}

# ë¸Œëœì¹˜ ì •ë¦¬
gf_cleanup() {
    print_info "ğŸ§¹ ë³‘í•© ì™„ë£Œëœ ë¸Œëœì¹˜ë“¤ ì •ë¦¬ ì¤‘..."
    
    # main ë¸Œëœì¹˜ë¡œ ì „í™˜
    git checkout main || return 1
    git pull origin main || return 1
    
    # ë¡œì»¬ ë¸Œëœì¹˜ ì¤‘ mainì— ë³‘í•©ëœ ê²ƒë“¤ ì‚­ì œ
    merged_branches=$(git branch --merged main | grep -v "main" | grep -v "*" | sed 's/^..//')
    if [[ -n "$merged_branches" ]]; then
        echo "ì‚­ì œí•  ë¡œì»¬ ë¸Œëœì¹˜ë“¤:"
        echo "$merged_branches"
        echo "$merged_branches" | xargs -n 1 git branch -d
        print_success "ë¡œì»¬ ë¸Œëœì¹˜ ì •ë¦¬ ì™„ë£Œ"
    else
        echo "ì‚­ì œí•  ë¡œì»¬ ë¸Œëœì¹˜ê°€ ì—†ìŠµë‹ˆë‹¤."
    fi
    
    # ì›ê²© ë¸Œëœì¹˜ ì •ë¦¬
    git remote prune origin
    print_success "ì›ê²© ë¸Œëœì¹˜ ì°¸ì¡° ì •ë¦¬ ì™„ë£Œ"
}

# ìµœê·¼ PR ëª©ë¡
gf_pr_list() {
    if command -v gh &> /dev/null; then
        print_info "ğŸ“‹ ìµœê·¼ Pull Request ëª©ë¡:"
        gh pr list --limit 10
    else
        print_warning "GitHub CLI(gh)ê°€ ì„¤ì¹˜ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤."
        print_info "GitHub ì›¹ì‚¬ì´íŠ¸ì—ì„œ PR ëª©ë¡ì„ í™•ì¸í•˜ì„¸ìš”."
    fi
}

# ë„ì›€ë§
gf_help() {
    echo "ğŸš€ GitHub Flow í—¬í¼ ëª…ë ¹ì–´ë“¤"
    echo "=============================="
    echo ""
    echo "ê¸°ë³¸ ì›Œí¬í”Œë¡œìš°:"
    echo "  gf_start <name>        ìƒˆë¡œìš´ ê¸°ëŠ¥ ê°œë°œ ì‹œì‘"
    echo "  gf_bugfix <name>       ë²„ê·¸ ìˆ˜ì • ì‹œì‘"
    echo "  gf_docs <name>         ë¬¸ì„œ ì—…ë°ì´íŠ¸ ì‹œì‘"
    echo "  gf_pr <title> [body]   Pull Request ìƒì„±"
    echo ""
    echo "ìœ í‹¸ë¦¬í‹°:"
    echo "  gf_status              í˜„ì¬ ìƒíƒœ í™•ì¸"
    echo "  gf_sync                main ë¸Œëœì¹˜ì™€ ë™ê¸°í™”"
    echo "  gf_cleanup             ë³‘í•©ëœ ë¸Œëœì¹˜ ì •ë¦¬"
    echo "  gf_pr_list             ìµœê·¼ PR ëª©ë¡"
    echo "  gf_help                ì´ ë„ì›€ë§"
    echo ""
    echo "ì˜ˆì‹œ ì›Œí¬í”Œë¡œìš°:"
    echo "  1. gf_start user-auth                    # ê¸°ëŠ¥ ê°œë°œ ì‹œì‘"
    echo "  2. # ì½”ë“œ ì‘ì„± ë° ì»¤ë°‹"
    echo "  3. gf_pr 'Add user auth' 'Description'   # PR ìƒì„±"
    echo "  4. # ë¦¬ë·° í›„ ë³‘í•©"
    echo "  5. gf_cleanup                            # ë¸Œëœì¹˜ ì •ë¦¬"
}

# ë³„ì¹­ ì„¤ì • í•¨ìˆ˜
setup_aliases() {
    echo "# GitHub Flow aliases" >> ~/.bashrc
    echo "alias gfs='gf_start'" >> ~/.bashrc
    echo "alias gfb='gf_bugfix'" >> ~/.bashrc
    echo "alias gfd='gf_docs'" >> ~/.bashrc
    echo "alias gfp='gf_pr'" >> ~/.bashrc
    echo "alias gfst='gf_status'" >> ~/.bashrc
    echo "alias gfsync='gf_sync'" >> ~/.bashrc
    echo "alias gfc='gf_cleanup'" >> ~/.bashrc
    echo "alias gfpl='gf_pr_list'" >> ~/.bashrc
    echo "alias gfh='gf_help'" >> ~/.bashrc
    
    print_success "ë³„ì¹­ì´ ~/.bashrcì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤."
    print_info "ìƒˆ í„°ë¯¸ë„ì„ ì—´ê±°ë‚˜ 'source ~/.bashrc'ë¥¼ ì‹¤í–‰í•˜ì„¸ìš”."
}

# ì´ˆê¸°í™” ë©”ì‹œì§€
if [ "${BASH_SOURCE[0]}" != "${0}" ]; then
    # ìŠ¤í¬ë¦½íŠ¸ê°€ sourceë¡œ ì‹¤í–‰ëœ ê²½ìš°
    print_success "GitHub Flow í—¬í¼ í•¨ìˆ˜ë“¤ì´ ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤."
    print_info "'gf_help' ëª…ë ¹ì–´ë¡œ ì‚¬ìš©ë²•ì„ í™•ì¸í•˜ì„¸ìš”."
fi